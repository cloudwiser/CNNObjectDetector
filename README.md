#### recog : a quick intro

##### Pre-requsiite : OpenCV

Please install 4.0.0 ideally or, if not available, v3.4.3+ as older versions will throw a CNN model exceptions given there is no cv.dnn functionality supported.

```sh
$ pip install opencv-python
```

If your environment is minus any UI output, there is the (lighter-weight) headless python package which can be installed:

```sh
$ pip install opencv-python-headless
```

##### Pre-requisite : model weight files

Each model requires a weights file to go with the pbtext or cfg file that describes the model architecture. 

The SSD MobileNet v1 file is in the repo but the SSD v2 and YOLO v3 weights files are huge to the point of exceeding the GitHub file upload limit and are not included.

If you wish to use these models, please review the top of `recog_argparse.py` for the relevant filename(s) to Google...although I'll add links to the necessary files here at some point.

Once you have downloaded the weights file, place it in the relevant 'model' sub-directory and use its path & name with the `--weights` argument as shown in the next section below.

##### Usage 

Run `python3 recog.py --help` for the full list of arguments which should hopefully be self-explanatory.

The mandatory arguments are the `model` which defines which model should be used, `classes` which is the path to the text file contatining the list of objects the model was trained on, `graph` which is the path to the text file defining the model architecture and `weights` which is a binary file containing all the weights for the model. Note this latter file is not included and needs to be downloaded to your local `./models/...` directory as mentioned above.

```sh
$ python3 recog.py --stream='http://192.168.0.1/video.cgi' --showlabels --headless --model='yolo3' --classes='./models/yolo3/yolo3.classes' --weights='./models/yolo3/yolo3.weights' --graph='./models/yolo3/yolo3.cfg' --out='../out'

$ python3 recog.py --video='../runners.mp4' --showlabels  --model='ssdmn1' --graph='./models/ssdmn1/deploy.prototxt' --weights='./models/ssdmn1/mobilenet_iter_73000.caffemodel' --classes='./models/ssdmn1/ssdmn1.classes' --out='../out'

$ python3 recog.py --model='<ssdmn1, ssdmn2 or yolo3>' --graph='<path>' --weights='<path>' --classes='<path>'    
(no input source argument = use your webcam)
```

##### Sample video : licence-free content for testing and threshold-tuning

If you require a sample video file of people objects aka persons to tune or test or simply experiment with, see the link below. 
The Pexel site also has other royalty-free content that may be relevant.

https://videos.pexels.com/videos/time-lapse-video-of-runners-855789


##### Headless OpenCV install on AWS Linux

The one-free-micro-instance-per-month on AWS is a nice bargain and I have configured a micro EC2 instance to run 2 instances of recog handling 2 separate RTSP video streams. Inference processing time will depend on model, stream resolution and number of recog instances obviously.

It requires some additional pre-requisites to be installed in order to first build OpenCV 4 as below and, assuming you are running this without X as the output, you can also install the headless version of the OpenCV python package.

Remember to add the `--headless` argument to the recog.py command line otherwise the script will error.

```sh
$ sudo yum update
$ sudo yum install git cmake gcc-c++ cmake3
$ git clone https://github.com/Itseez/opencv.git
$ cd opencv
$ mkdir ./build
$ git checkout
$ cd ./build
$ cmake3 ../
$ sudo yum install numpy python-devel pip
$ sudo pip install opencv-python
$ pip install opencv-python-headless --user
$ pip install supervisor
```
The `supervisor` install is not mandatory but is is a great solution to running detached python-based processs on Linux.
Important if you are wanting to run continously and unattended as these processes may go zombie once you logout or close your ssh session into the EC2 instance.

See http://supervisord.org/introduction.html for more info on what is an amazingly feature-rich package.


##### Image upload via recog_uploader

This is a simple FTP uploader script that monitors a local directory and copies or moves image files generated by `recog.py --out='<path>'` to a remote directory hosted on a FTP server.

See `python3 recog_uploader.py --help` for the set of arguments available and, in the case of `host`, `username` and `password` required.

At the time of writing, the script doesn't support anonymous FTP login nor check for the presence of previously uploaded image files. Another couple of TODO's...or pull request ;-)


##### Pull requests

Always welcome :-)


##### Background reading

Given the continual research and application of CNN-based models to vision processing, there are a ton of articles on Medium and elsewhere that details the model architecture, performance (mAP accuracy vs inference speed), training as well as (for some) usage with OpenCV as we are doing here. A couple of relevant on the OpenCV aspects that might help if you are wanting to dive deeper... 

https://github.com/opencv/opencv/wiki/TensorFlow-Object-Detection-API
https://github.com/opencv/opencv_extra/tree/master/testdata/dnn


##### TensorFlow graph file creation

You shouldn't need to recreate the pbtxt (graph) file but future changes in either Tensorflow and/or OpenCV dnn might necessitate it. Equally, if you decide to deploy a modified graph following re-training, the command line from the TF GH model repo is shown below...which I have not tested:

```sh
$ python tf_text_graph_faster_rcnn.py --input /path/to/model.pb --config /path/to/example.config --output /path/to/graph.pbtxt
```

Example:

```sh
$ python tf_text_graph_ssd.py --input ./ssd_mobilenet_v2_coco_2018_03_29/frozen_inference_graph.pb --config ./ssd_mobilenet_v2_coco.config --output ./ssd_mobilenet_v2_coco_2019_01_28.pbtxt
```
